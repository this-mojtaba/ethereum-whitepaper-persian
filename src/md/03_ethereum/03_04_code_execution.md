# اجرای کد

(Code Execution)

کد در قراردادهای اتریوم به یک زبان بایت‌کد سطح پایین و مبتنی بر پشته نوشته می‌شود که به آن «کد ماشین مجازی اتریوم» (Ethereum Virtual Machine Code یا EVM Code) گفته می‌شود. این کد از یک رشته بایت تشکیل شده است که هر بایت نمایانگر یک عملیات است. به‌طور کلی، اجرای کد یک حلقهٔ بی‌نهایت است که در آن، عملیاتِ مربوط به شمارندهٔ فعلی برنامه (Program Counter) — که از صفر شروع می‌شود — به‌صورت پی‌درپی اجرا می‌گردد و سپس شمارندهٔ برنامه یک واحد افزایش می‌یابد؛ تا زمانی که به انتهای کد برسیم یا یک خطا رخ دهد یا دستور STOP یا RETURN مشاهده شود.

عملیات‌ها به سه نوع فضا برای ذخیرهٔ داده دسترسی دارند:

- **پشته (Stack)**: یک ساختار آخرین‌ورود-اولین‌خروج (Last-In-First-Out) که مقادیر ۳۲ بایتی می‌توانند در آن قرار داده شوند یا از آن برداشته شوند.
- **حافظه (Memory)**: یک آرایهٔ بایتی با قابلیت گسترش نامحدود.
- **فضای ذخیره‌سازی بلندمدت قرارداد (Storage)**: یک انبار کلید/مقدار که کلیدها و مقدارها هر دو ۳۲ بایتی هستند. برخلاف پشته و حافظه که پس از پایان محاسبه بازنشانی می‌شوند، ذخیره‌سازی در بلندمدت باقی می‌ماند.

کد همچنین می‌تواند به مقدار، فرستنده و دادهٔ پیام ورودی دسترسی داشته باشد، و نیز داده‌های سرآیند بلاک را بخواند؛ همچنین کد می‌تواند در خروجی، یک آرایهٔ بایتی از داده را بازگرداند.

مدل اجرایی رسمی کد EVM به شکل شگفت‌آوری ساده است. هنگامی که ماشین مجازی اتریوم در حال اجراست، کل وضعیت محاسباتی آن را می‌توان با یک تاپل به‌شکل `(block_state, transaction, message, code, memory, stack, pc, gas)` تعریف کرد؛ که در آن `block_state` وضعیت جهانی شامل تمام حساب‌ها است و موجودی‌ها و ذخیره‌سازی را نیز در بر می‌گیرد. در هر دور از اجرا، دستور فعلی با گرفتن بایتِ شمارهٔ `pc` از کد مشخص می‌شود و هر دستور تعریف خاص خود را دارد که بیان می‌کند چگونه این تاپل را تغییر می‌دهد.

برای مثال، دستور `ADD` دو مقدار را از پشته برمی‌دارد و حاصل جمع آن‌ها را روی پشته قرار می‌دهد، گاز را به میزان ۱ کاهش می‌دهد و `pc` را یک واحد افزایش می‌دهد. دستور `SSTORE` نیز دو مقدار بالایی پشته را برمی‌دارد و مقدار دوم را در فضای ذخیره‌سازی قرارداد، در اندیسی که مقدار اول مشخص کرده است قرار می‌دهد؛ همچنین می‌تواند تا ۲۰۰ واحد گاز را کاهش دهد و `pc` را یک واحد افزایش دهد. با این‌که راه‌های زیادی برای بهینه‌سازی اتریوم با استفاده از کامپایل در لحظه (Just-In-Time Compilation) وجود دارد، یک پیاده‌سازی پایه از اتریوم را می‌توان با چند صد خط کد انجام داد.

Page 17
