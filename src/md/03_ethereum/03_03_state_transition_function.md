# تابع انتقال وضعیت اتریوم

(Ethereum State Transition Function)

تابع انتقال وضعیت در اتریوم که با APPLY(S, TX) → S' نمایش داده می‌شود، به‌صورت زیر تعریف می‌گردد:

1. بررسی می‌شود که تراکنش به‌درستی شکل گرفته باشد (برای مثال تعداد مقادیر صحیح باشد)، امضا معتبر باشد و نانس تراکنش با نانس موجود در حساب فرستنده مطابقت داشته باشد. در غیر این صورت، خطا بازگردانده می‌شود.

2. کارمزد تراکنش به‌صورت STARTGAS × GASPRICE محاسبه می‌شود و آدرس فرستنده از روی امضا تعیین می‌گردد. این مقدار از موجودی حساب فرستنده کسر شده و نانس فرستنده یک واحد افزایش می‌یابد. اگر موجودی کافی نباشد، خطا بازگردانده می‌شود.

3. مقدار GAS برابر با STARTGAS مقداردهی اولیه می‌شود و به‌ازای هر بایت از داده‌های تراکنش، مقدار مشخصی گاز کسر می‌گردد تا هزینهٔ داده‌های موجود در تراکنش پرداخت شود.

4. مقدار اتر ارسالی تراکنش از حساب فرستنده به حساب گیرنده منتقل می‌شود. اگر حساب گیرنده هنوز وجود نداشته باشد، ایجاد می‌شود. اگر حساب گیرنده یک حساب قراردادی باشد، کد قرارداد اجرا می‌شود؛ یا تا پایان اجرا، یا تا زمانی که گاز تمام شود.

5. اگر انتقال مقدار به دلیل کافی نبودن موجودی فرستنده شکست بخورد، یا اجرای کد به دلیل اتمام گاز متوقف شود، تمام تغییرات وضعیت — به‌جز پرداخت کارمزد — بازگردانده می‌شوند و کارمزدها به حساب استخراج‌کننده افزوده می‌شوند.

6. در غیر این صورت، کارمزد مربوط به گاز استفاده‌نشده به فرستنده بازگردانده می‌شود و کارمزد گاز مصرف‌شده به استخراج‌کننده پرداخت می‌گردد.

---

برای مثال، فرض کنید کد قرارداد به‌شکل زیر باشد:

if !contract.storage[msg.data[0]]:
contract.storage[msg.data[0]] = msg.data[1]

توجه داشته باشید که در عمل، کد قراردادها به زبان سطح پایین ماشین مجازی اتریوم (EVM) نوشته می‌شوند؛ این مثال برای شفافیت، به زبان سطح‌بالای Serpent نوشته شده است و قابل تبدیل به کد EVM است.

فرض کنید فضای ذخیره‌سازی قرارداد در ابتدا خالی است و یک تراکنش با مشخصات زیر ارسال می‌شود:

- مقدار اتر: ۱۰
- گاز: ۲۰۰۰
- قیمت گاز: ۰٫۰۰۱ اتر
- داده‌ها: `[2, 'CHARLIE']`

فرآیند اجرای تابع انتقال وضعیت در این حالت به‌صورت زیر خواهد بود:

1. بررسی می‌شود که تراکنش معتبر و به‌درستی شکل گرفته باشد.
2. بررسی می‌شود که فرستنده حداقل 2000 × 0.001 = 2 اتر برای پرداخت کارمزد داشته باشد؛ در این صورت، ۲ اتر از حساب او کسر می‌شود.
3. مقدار گاز برابر با ۲۰۰۰ مقداردهی می‌شود. با فرض این‌که طول تراکنش ۱۷۰ بایت و هزینهٔ هر بایت ۵ باشد، مقدار ۸۵۰ گاز کسر می‌شود و ۱۱۵۰ گاز باقی می‌ماند.
4. مقدار ۱۰ اتر دیگر از حساب فرستنده کسر شده و به حساب قرارداد افزوده می‌شود.
5. کد قرارداد اجرا می‌شود. در این مثال، قرارداد بررسی می‌کند که آیا فضای ذخیره‌سازی در اندیس ۲ استفاده شده است یا خیر؛ چون خالی است، مقدار CHARLIE در آن ذخیره می‌شود. فرض می‌کنیم این عملیات ۱۸۷ گاز مصرف کند، در نتیجه مقدار گاز باقی‌مانده برابر با ۹۶۳ خواهد بود.
6. مقدار 963 × 0.001 = 0.963 اتر به حساب فرستنده بازگردانده می‌شود و وضعیت نهایی بازگشت داده می‌شود.

اگر در سمت گیرندهٔ تراکنش هیچ قراردادی وجود نداشت، کارمزد کل تراکنش صرفاً برابر با GASPRICE ضربدر طول تراکنش (بر حسب بایت) می‌بود و داده‌های همراه تراکنش اهمیتی نداشتند.

همچنین، پیام‌هایی که توسط قراردادها ایجاد می‌شوند می‌توانند برای محاسباتی که راه‌اندازی می‌کنند، محدودیت گاز تعیین کنند. اگر این محاسبات فرعی با اتمام گاز مواجه شوند، تنها تا نقطهٔ فراخوانی پیام بازگردانده می‌شوند. بنابراین، همانند تراکنش‌ها، قراردادها نیز می‌توانند با تعیین سقف‌های سخت‌گیرانه، منابع محاسباتی محدود خود را ایمن کنند.
